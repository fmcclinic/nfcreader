<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FMC Clinic - NFC Reader</title>
    <style>
        /* ... giữ nguyên phần style cũ ... */
        .raw-data {
            font-family: monospace;
            word-break: break-all;
            background: #f5f5f5;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FMC Clinic - NFC Reader (Debug)</h1>
        </div>

        <button onclick="startNFC()">Quét NFC</button>
        <div id="status">Nhấn nút để bắt đầu quét...</div>
    </div>

    <script>
        function bytesToHexString(bytes) {
            return Array.from(bytes)
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        async function startNFC() {
            const status = document.getElementById('status');
            
            if (!('NDEFReader' in window)) {
                status.innerHTML = '<div class="error">Thiết bị không hỗ trợ Web NFC. Vui lòng sử dụng Chrome trên Android.</div>';
                return;
            }

            try {
                status.textContent = 'Đang khởi tạo NFC...';
                const ndef = new NDEFReader();
                await ndef.scan();
                status.textContent = 'Đang đợi thẻ NFC... Vui lòng đặt CCCD lên điện thoại';
                
                ndef.addEventListener("reading", ({ message, serialNumber }) => {
                    let output = `<div class="success">✓ Đã đọc thành công!</div>`;
                    output += `<strong>Serial Number:</strong> ${serialNumber}<br>`;
                    output += `<strong>Số records:</strong> ${message.records.length}<br><br>`;

                    message.records.forEach((record, index) => {
                        output += `<strong>Record ${index + 1}:</strong><br>`;
                        output += `- Loại: ${record.recordType}<br>`;
                        output += `- Encoding: ${record.encoding}<br>`;
                        output += `- Lang: ${record.lang}<br>`;
                        output += `- MediaType: ${record.mediaType}<br>`;
                        
                        if (record.data) {
                            const hexData = bytesToHexString(record.data);
                            output += `<div class="raw-data">Raw data (hex): ${hexData}</div>`;
                            
                            try {
                                const textDecoder = new TextDecoder(record.encoding || 'utf-8');
                                const textData = textDecoder.decode(record.data);
                                output += `<div class="raw-data">Text data: ${textData}</div>`;
                            } catch (e) {
                                output += `<div class="error">Không thể decode text: ${e.message}</div>`;
                            }
                        }
                        output += '<br>';
                    });

                    status.innerHTML = output;
                });

                ndef.addEventListener("error", (error) => {
                    status.innerHTML = `<div class="error">Lỗi: ${error.message}</div>`;
                });

            } catch (error) {
                status.innerHTML = `
                    <div class="error">
                        <strong>Lỗi:</strong> ${error.message}<br><br>
                        Có thể do:<br>
                        - NFC chưa được bật<br>
                        - Chưa cấp quyền NFC cho trình duyệt<br>
                        - Thiết bị không hỗ trợ NFC<br>
                        - CCCD có thể sử dụng định dạng NFC đặc biệt
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
