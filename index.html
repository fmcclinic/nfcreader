<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FMC Clinic - Raw NFC Reader</title>
    <style>
        body { 
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        #status {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            line-height: 1.5;
        }
        #debug {
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <div class="container">
        <h2>FMC NFC Reader (Debug)</h2>
        <div>
            <button onclick="startScan()">Quét NFC (Chế độ thường)</button>
            <button onclick="startWatchingNFC()">Theo dõi NFC (Watch mode)</button>
        </div>
        <div id="status">Chọn chế độ quét...</div>
        <div id="debug"></div>
    </div>

    <script>
        const debug = document.getElementById('debug');
        const status = document.getElementById('status');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debug.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            debug.scrollTop = debug.scrollHeight;
        }

        async function startScan() {
            if (!('NDEFReader' in window)) {
                status.innerHTML = '<span class="error">Trình duyệt không hỗ trợ Web NFC</span>';
                return;
            }

            try {
                status.textContent = 'Đang khởi tạo NFC...';
                log('Khởi tạo NDEFReader');
                
                const ndef = new NDEFReader();
                await ndef.scan();
                
                status.textContent = 'Đang đợi thẻ NFC...';
                log('Đang quét NFC');

                ndef.addEventListener("reading", (event) => {
                    log('Phát hiện thẻ!', 'success');
                    log(`Serial Number: ${event.serialNumber}`);
                    
                    event.message.records.forEach((record, index) => {
                        log(`Record ${index + 1}:`);
                        log(`- Type: ${record.recordType}`);
                        log(`- Media Type: ${record.mediaType || 'N/A'}`);
                        
                        if (record.data) {
                            try {
                                // Thử decode UTF-8
                                const utf8Data = new TextDecoder().decode(record.data);
                                log(`- UTF8 Data: ${utf8Data}`);
                                
                                // Hiển thị hex
                                const hexData = Array.from(record.data)
                                    .map(b => b.toString(16).padStart(2, '0'))
                                    .join(' ');
                                log(`- HEX Data: ${hexData}`);
                                
                            } catch (e) {
                                log(`- Error decoding: ${e.message}`, 'error');
                            }
                        }
                    });

                    status.innerHTML = `<span class="success">Đã đọc xong! Xem log bên dưới</span>`;
                });

                ndef.addEventListener("error", (error) => {
                    log(`Lỗi: ${error.message}`, 'error');
                    status.innerHTML = `<span class="error">Lỗi: ${error.message}</span>`;
                });

            } catch (error) {
                log(`Exception: ${error.message}`, 'error');
                status.innerHTML = `<span class="error">Lỗi: ${error.message}</span>`;
            }
        }

        async function startWatchingNFC() {
            try {
                const options = {
                    recordType: "empty",  // Try to read any record type
                    signal: (new AbortController()).signal
                };

                status.textContent = 'Đang theo dõi NFC events...';
                log('Bắt đầu watch mode');

                navigator.permissions.query({ name: "nfc" }).then((result) => {
                    log(`NFC Permission: ${result.state}`);
                });

                const ndef = new NDEFReader();
                await ndef.scan();

                ndef.onreading = (event) => {
                    log('NFC Event detected!', 'success');
                    log(`Raw event data: ${JSON.stringify(event, null, 2)}`);
                };

                ndef.onreadingerror = (error) => {
                    log(`Reading error: ${error}`, 'error');
                };

            } catch (error) {
                log(`Watch mode error: ${error.message}`, 'error');
                status.innerHTML = `<span class="error">Lỗi watch mode: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>
